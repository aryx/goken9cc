# can use $CC_ -S to see the assembly code
TOP=../../..
<$TOP/mkconfig
<$TOP/mkfiles/$objtype/mkfile

all:V: helloc.exe
clean:V:
        rm -f *.[5678ijv] *.exe *.a
test_one:V: all
        ./helloc.exe

#TODO? 'ar rc'? in principia we use 'ar vu'
#old: $LD_ -X to require NOSPLIT for all linked code, especially in $stem.6
#alt: ar rc libmini.a *.$O_   below
helloc.exe: helloc.c
   $CC_ -D$objtype -c $prereq
   $AS_ -D$objtype -c start_$objtype.s
   $AS_ -D$objtype -c xwrite_$objtype.s
   $AS_ -D$objtype -c xexit_$objtype.s
   $AR_ rc libmini.a start_$objtype.$O_ xwrite_$objtype.$O_ xexit_$objtype.$O_
   $LD_ -L. -o $target -E _start helloc.$O_

#alt: 5l_ -H7 -L. -o $target -E _start helloc.5 xwrite_arm.5 xexit_arm.5 start_arm.5
# when ar_ is not working
#alt: could factorize with previous rule but would need some start_arm_.s
# symlink to start_arm.s
helloc_arm_.exe: helloc.c
   5c__ -Darm_ -c helloc.c
   5a__ -Darm_ -c xwrite_arm.s
   5a__ -Darm_ -c xexit_arm.s
   5a__ -Darm_ -c start_arm.s
   ar_ rc libmini.a start_arm.5 xwrite_arm.5 xexit_arm.5
   5l__ -H7 -L. -o $target -E _start helloc.5

#TODO: 386 riscv
ARCHS=amd64 arm arm64 mips
test:V:
        for (arch in $ARCHS) {
           echo $arch
           mk clean
           #alt: build 5.helloc 8.helloc
           mk 'objtype='$arch
           qemu-$arch ./helloc.exe
        }
	#alt: special if in for loop above
	echo arm_
	mk clean
	mk helloc_arm_.exe
	qemu-arm ./helloc_arm_.exe
